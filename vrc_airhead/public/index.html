<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Address Checker</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="container">
    <h1>Address Checker</h1>
    <form id="addressForm">
      <textarea
        id="addresses"
        rows="10"
        placeholder="Enter addresses, one per line"
      ></textarea>
      <button type="submit">Check Addresses</button>
    </form>
    <div id="results"></div>
    <div id="download"></div>
  </div>

  <script>
    const form = document.getElementById("addressForm");
    const resultsDiv = document.getElementById("results");
    const downloadDiv = document.getElementById("download");

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      resultsDiv.innerHTML = "Processing...";
      downloadDiv.innerHTML = "";

      const addresses = document.getElementById("addresses").value
        .split("\n")
        .map((addr) => addr.trim())
        .filter((addr) => addr);

      if (addresses.length === 0) {
        resultsDiv.innerHTML = "<p style='color:red;'>No addresses provided.</p>";
        return;
      }

      try {
        const response = await fetch("/api/check-addresses", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ addresses }),
        });

        const data = await response.json();
        if (!response.ok) {
          resultsDiv.innerHTML = `<p style='color:red;'>Error: ${data.error}</p>`;
          return;
        }

        let html = "<table><tr><th>Address</th><th>Wallet Rank</th><th>Whale</th><th>Priority</th><th>Fat Meter</th><th>Guaranteed Mint</th></tr>";
        data.forEach((row) => {
          html += `<tr>
            <td>${row.address}</td>
            <td>${row.walletRank || "N/A"}</td>
            <td>${row.whale || "N/A"}</td>
            <td>${row.priority || "N/A"}</td>
            <td>${row.fatMeter || "N/A"}</td>
            <td>${row.guaranteedMint || "N/A"}</td>
          </tr>`;
        });
        html += "</table>";

        resultsDiv.innerHTML = html;

        // Download CSV link
        const downloadLink = document.createElement("a");
        downloadLink.href = `/api/download-csv?data=${encodeURIComponent(
          JSON.stringify(data)
        )}`;
        downloadLink.innerText = "Download Results as CSV";
        downloadLink.download = "results.csv";
        downloadDiv.appendChild(downloadLink);
      } catch (err) {
        resultsDiv.innerHTML = `<p style='color:red;'>Error: ${err.message}</p>`;
      }
    });
  </script>
</body>
</html>
